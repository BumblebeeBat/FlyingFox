defmodule NewTcp do
	use Application
	def start(_type, _args) do
		import Supervisor.Spec, warn: false
		children = [
			worker(__MODULE__, [], function: :run)
		]
		opts = [strategy: :one_for_one, name: DdsBlog.Supervisor]
		Supervisor.start_link(children, opts)
	end
	def run do
		routes = [
			{"/", Tcp.Handler, []},
			{"/:something", DdsBlog.Handler, []},
			{"/static/[...]", :cowboy_static, {:dir, "lib/static_files"}}			
		]
		
		dispatch = :cowboy_router.compile([{:_, routes}])
		
		opts = [port: 8000]
		env = [env: [dispatch: dispatch]]
		
		{:ok, _pid} = :cowboy.start_http(:http, 100, opts, env)
	end
end

defmodule Tcp.Handler do
	def init({:tcp, :http}, req, opts) do
		{:ok, req, opts}
	end
	def handle(req, state) do
		headers = [{"content-type", "text/plain"}]
		body = "output output"
		{:ok, resp} = :cowboy_req.reply(200, headers, body, req)
		{:ok, resp, state}
	end
	def terminate(_reason, _req, _state) do
		:ok
	end
end
