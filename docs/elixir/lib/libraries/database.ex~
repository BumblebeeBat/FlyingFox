defmodule Database do
	def db_lock(f) do
		path = System.cwd <> "/dbs" #different in windows?
		File.mkdir(path)
		{status, db} = Exleveldb.open(path <> "/channeldb")
		case status do
			:ok ->
				#we have a lock on the db, so no one else can use it till we are done.
				out = f.(db)
				Exleveldb.close(db)#unlock
				out
			:db_open ->#someone else has a lock on the db.
				:timer.sleep(50)
				db_lock(f)
			true -> IO.puts("db broke")
		end
	end
	def put(key, val, loc) do Task.start_link(fn() -> db_lock(fn(db) -> Exleveldb.put(db, key, PackWrap.pack(val), []) end, loc) end) end

end
